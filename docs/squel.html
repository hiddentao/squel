<!DOCTYPE html>

<html>
<head>
  <title>#</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="mysql.html">
                mysql.coffee
              </a>
            
              
              <a class="source" href="postgres.html">
                postgres.coffee
              </a>
            
              
              <a class="source" href="squel.html">
                squel.coffee
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <h1 id="-">#</h1>

            </div>
            
            <div class="content"><div class='highlight'><pre>Copyright (c) Ramesh Nair (hiddentao.com)

Permission <span class="hljs-keyword">is</span> hereby granted, free <span class="hljs-keyword">of</span> charge, to any person
obtaining a copy <span class="hljs-keyword">of</span> <span class="hljs-keyword">this</span> software <span class="hljs-keyword">and</span> associated documentation
files (the <span class="hljs-string">"Software"</span>), to deal <span class="hljs-keyword">in</span> the Software without
restriction, including without limitation the rights to use,
copy, modify, merge, publish, distribute, sublicense, <span class="hljs-keyword">and</span>/<span class="hljs-keyword">or</span> sell
copies <span class="hljs-keyword">of</span> the Software, <span class="hljs-keyword">and</span> to permit persons to whom the
Software <span class="hljs-keyword">is</span> furnished to <span class="hljs-keyword">do</span> so, subject to the following
<span class="hljs-attribute">conditions</span>:

The above copyright notice <span class="hljs-keyword">and</span> <span class="hljs-keyword">this</span> permission notice shall be
included <span class="hljs-keyword">in</span> all copies <span class="hljs-keyword">or</span> substantial portions <span class="hljs-keyword">of</span> the Software.

THE SOFTWARE IS PROVIDED <span class="hljs-string">"AS IS"</span>, WITHOUT WARRANTY OF ANY KIND,
EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES
OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT
HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY,
WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR
OTHER DEALINGS IN THE SOFTWARE.</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <h1 id="-">#</h1>

            </div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>Holds classes</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>cls = {}</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>Extend given object’s with other objects’ properties, overriding existing ones if necessary</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">_extend</span> = <span class="hljs-params">(dst, sources...)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> sources
        <span class="hljs-keyword">for</span> src <span class="hljs-keyword">in</span> sources
            <span class="hljs-keyword">if</span> src
                <span class="hljs-keyword">for</span> own k,v <span class="hljs-keyword">of</span> src
                    dst[k] = v
    dst</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>Default query builder options</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>cls.DefaultQueryBuilderOptions =</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>If true then table names will be rendered inside quotes. The quote character used is configurable via the
nameQuoteCharacter option.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">autoQuoteTableNames</span>: <span class="hljs-literal">false</span></pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>If true then field names will rendered inside quotes. The quote character used is configurable via the
nameQuoteCharacter option.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">autoQuoteFieldNames</span>: <span class="hljs-literal">false</span></pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>If true then alias names will rendered inside quotes. The quote character used is configurable via the
tableAliasQuoteCharacter and fieldAliasQuoteCharacter options.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">autoQuoteAliasNames</span>: <span class="hljs-literal">true</span></pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>The quote character used for when quoting table and field names</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">nameQuoteCharacter</span>: <span class="hljs-string">'`'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>The quote character used for when quoting table alias names</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">tableAliasQuoteCharacter</span>: <span class="hljs-string">'`'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>The quote character used for when quoting table alias names</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">fieldAliasQuoteCharacter</span>: <span class="hljs-string">'"'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>Custom value handlers where key is the value type and the value is the handler function</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">valueHandlers</span>: []</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>Number parameters returned from toParam() as $1, $2, etc. Default is to use ‘?’</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">numberedParameters</span>: <span class="hljs-literal">false</span></pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>Global custom value handlers for all instances of builder</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>cls.globalValueHandlers = []</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>Register a value type handler</p>
<p>Note: this will override any existing handler registered for this value type.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">registerValueHandler</span> = <span class="hljs-params">(handlers, type, handler)</span> -&gt;</span>
  <span class="hljs-keyword">unless</span> <span class="hljs-string">'function'</span> <span class="hljs-keyword">is</span> <span class="hljs-keyword">typeof</span> type
   <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Error <span class="hljs-string">"type must be a class constructor"</span>

  <span class="hljs-keyword">unless</span> <span class="hljs-string">'function'</span> <span class="hljs-keyword">is</span> <span class="hljs-keyword">typeof</span> handler
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Error <span class="hljs-string">"handler must be a function"</span>

  <span class="hljs-keyword">for</span> typeHandler <span class="hljs-keyword">in</span> handlers
    <span class="hljs-keyword">if</span> typeHandler.type <span class="hljs-keyword">is</span> type
      typeHandler.handler = handler
      <span class="hljs-keyword">return</span>

  handlers.push
    <span class="hljs-attribute">type</span>: type
    <span class="hljs-attribute">handler</span>: handler</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>Get value type handler for given type</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">getValueHandler</span> = <span class="hljs-params">(value, handlerLists...)</span> -&gt;</span>
  <span class="hljs-keyword">for</span> handlers <span class="hljs-keyword">in</span> handlerLists
    <span class="hljs-keyword">for</span> typeHandler <span class="hljs-keyword">in</span> handlers
      <span class="hljs-keyword">if</span> value <span class="hljs-keyword">instanceof</span> typeHandler.type
        <span class="hljs-keyword">return</span> typeHandler.handler
  <span class="hljs-literal">undefined</span></pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>Register a new value handler</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>cls.<span class="hljs-function"><span class="hljs-title">registerValueHandler</span> = <span class="hljs-params">(type, handler)</span> -&gt;</span>
  registerValueHandler cls.globalValueHandlers, type, handler</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>Base class for cloneable builders</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">cls</span>.<span class="hljs-title">Cloneable</span></span></pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>Clone this builder</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">clone</span>:<span class="hljs-function"> -&gt;</span>
    newInstance = <span class="hljs-keyword">new</span> <span class="hljs-property">@constructor</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>Fast deep copy using JSON conversion, see <a href="http://stackoverflow.com/a/5344074">http://stackoverflow.com/a/5344074</a></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    _extend newInstance, JSON.parse(JSON.stringify(@))</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>Base class for all builders</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">cls</span>.<span class="hljs-title">BaseBuilder</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">cls</span>.<span class="hljs-title">Cloneable</span></span></pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>Constructor</p>
<p>options is an Object overriding one or more of cls.DefaultQueryBuilderOptions</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">constructor</span>: <span class="hljs-function"><span class="hljs-params">(options)</span> -&gt;</span>
    defaults = JSON.parse(JSON.stringify(cls.DefaultQueryBuilderOptions))
    <span class="hljs-property">@options</span> = _extend {}, defaults, options</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>Register a custom value handler for this builder instance.</p>
<p>Note: this will override any globally registered handler for this value type.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">registerValueHandler</span>: <span class="hljs-function"><span class="hljs-params">(type, handler)</span> -&gt;</span>
    registerValueHandler <span class="hljs-property">@options</span>.valueHandlers, type, handler
    @</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>Get class name of given object.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">_getObjectClassName</span>: <span class="hljs-function"><span class="hljs-params">(obj)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> obj &amp;&amp; obj.constructor &amp;&amp; obj.constructor.toString
      arr = obj.constructor.toString().match <span class="hljs-regexp">/function\s*(\w+)/</span>;
      <span class="hljs-keyword">if</span> arr &amp;&amp; arr.length <span class="hljs-keyword">is</span> <span class="hljs-number">2</span>
        <span class="hljs-keyword">return</span> arr[<span class="hljs-number">1</span>]
    <span class="hljs-keyword">return</span> <span class="hljs-literal">undefined</span></pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>Sanitize the given condition.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">_sanitizeCondition</span>: <span class="hljs-function"><span class="hljs-params">(condition)</span> -&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>If it’s an expression builder instance then convert it to string form.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> condition <span class="hljs-keyword">instanceof</span> cls.Expression
      condition = condition.toString()

    <span class="hljs-keyword">if</span> <span class="hljs-string">"string"</span> <span class="hljs-keyword">isnt</span> <span class="hljs-keyword">typeof</span> condition
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Error <span class="hljs-string">"condition must be a string or Expression instance"</span>

    condition</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p>Sanitize the given name.
The ‘type’ parameter is used to construct a meaningful error message in case validation fails.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">_sanitizeName</span>: <span class="hljs-function"><span class="hljs-params">(value, type)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> <span class="hljs-string">"string"</span> <span class="hljs-keyword">isnt</span> <span class="hljs-keyword">typeof</span> value
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Error <span class="hljs-string">"<span class="hljs-subst">#{type}</span> must be a string"</span>
    value

  <span class="hljs-attribute">_sanitizeField</span>: <span class="hljs-function"><span class="hljs-params">(item)</span> -&gt;</span>
    sanitized = <span class="hljs-property">@_sanitizeName</span> item, <span class="hljs-string">"field name"</span>

    <span class="hljs-keyword">if</span> <span class="hljs-property">@options</span>.autoQuoteFieldNames
      <span class="hljs-string">"<span class="hljs-subst">#{<span class="hljs-property">@options</span>.nameQuoteCharacter}</span><span class="hljs-subst">#{sanitized}</span><span class="hljs-subst">#{<span class="hljs-property">@options</span>.nameQuoteCharacter}</span>"</span>
    <span class="hljs-keyword">else</span>
      sanitized

  <span class="hljs-attribute">_sanitizeTable</span>: <span class="hljs-function"><span class="hljs-params">(item, allowNested = <span class="hljs-literal">false</span>)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> allowNested
      <span class="hljs-keyword">if</span> <span class="hljs-string">"string"</span> <span class="hljs-keyword">is</span> <span class="hljs-keyword">typeof</span> item
        sanitized = item
      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> item <span class="hljs-keyword">instanceof</span> cls.QueryBuilder <span class="hljs-keyword">and</span> item.isNestable()</pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p>allow nested queries</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">return</span> item
      <span class="hljs-keyword">else</span>
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Error <span class="hljs-string">"table name must be a string or a nestable query instance"</span>
    <span class="hljs-keyword">else</span>
      sanitized = <span class="hljs-property">@_sanitizeName</span> item, <span class="hljs-string">'table name'</span>


    <span class="hljs-keyword">if</span> <span class="hljs-property">@options</span>.autoQuoteTableNames
      <span class="hljs-string">"<span class="hljs-subst">#{<span class="hljs-property">@options</span>.nameQuoteCharacter}</span><span class="hljs-subst">#{sanitized}</span><span class="hljs-subst">#{<span class="hljs-property">@options</span>.nameQuoteCharacter}</span>"</span>
    <span class="hljs-keyword">else</span>
      sanitized

  <span class="hljs-attribute">_sanitizeTableAlias</span>: <span class="hljs-function"><span class="hljs-params">(item)</span> -&gt;</span>
    sanitized = <span class="hljs-property">@_sanitizeName</span> item, <span class="hljs-string">"table alias"</span>

    <span class="hljs-keyword">if</span> <span class="hljs-property">@options</span>.autoQuoteAliasNames
      <span class="hljs-string">"<span class="hljs-subst">#{<span class="hljs-property">@options</span>.tableAliasQuoteCharacter}</span><span class="hljs-subst">#{sanitized}</span><span class="hljs-subst">#{<span class="hljs-property">@options</span>.tableAliasQuoteCharacter}</span>"</span>
    <span class="hljs-keyword">else</span>
      sanitized

  <span class="hljs-attribute">_sanitizeFieldAlias</span>: <span class="hljs-function"><span class="hljs-params">(item)</span> -&gt;</span>
    sanitized = <span class="hljs-property">@_sanitizeName</span> item, <span class="hljs-string">"field alias"</span>

    <span class="hljs-keyword">if</span> <span class="hljs-property">@options</span>.autoQuoteAliasNames
      <span class="hljs-string">"<span class="hljs-subst">#{<span class="hljs-property">@options</span>.fieldAliasQuoteCharacter}</span><span class="hljs-subst">#{sanitized}</span><span class="hljs-subst">#{<span class="hljs-property">@options</span>.fieldAliasQuoteCharacter}</span>"</span>
    <span class="hljs-keyword">else</span>
      sanitized</pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <p>Sanitize the given limit/offset value.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">_sanitizeLimitOffset</span>: <span class="hljs-function"><span class="hljs-params">(value)</span> -&gt;</span>
    value = parseInt(value)
    <span class="hljs-keyword">if</span> <span class="hljs-number">0</span> &gt; value <span class="hljs-keyword">or</span> isNaN(value)
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Error <span class="hljs-string">"limit/offset must be &gt;= 0"</span>
    value</pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <p>Santize the given field value</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">_sanitizeValue</span>: <span class="hljs-function"><span class="hljs-params">(item)</span> -&gt;</span>
    itemType = <span class="hljs-keyword">typeof</span> item
    <span class="hljs-keyword">if</span> <span class="hljs-literal">null</span> <span class="hljs-keyword">is</span> item</pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <p>null is allowed</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> <span class="hljs-string">"string"</span> <span class="hljs-keyword">is</span> itemType <span class="hljs-keyword">or</span> <span class="hljs-string">"number"</span> <span class="hljs-keyword">is</span> itemType <span class="hljs-keyword">or</span> <span class="hljs-string">"boolean"</span> <span class="hljs-keyword">is</span> itemType</pre></div></div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <p>primitives are allowed</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">else</span>
      typeIsValid = <span class="hljs-literal">undefined</span> <span class="hljs-keyword">isnt</span> getValueHandler(item, <span class="hljs-property">@options</span>.valueHandlers, cls.globalValueHandlers)
      <span class="hljs-keyword">unless</span> typeIsValid</pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <p>type is not valid</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Error <span class="hljs-string">"field value must be a string, number, boolean, null or one of the registered custom value types"</span>
    item</pre></div></div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <p>Escape a string value, e.g. escape quotes and other characters within it.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">_escapeValue</span>: <span class="hljs-function"><span class="hljs-params">(str)</span> -&gt;</span> str</pre></div></div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              <p>Format the given custom value</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">_formatCustomValue</span>: <span class="hljs-function"><span class="hljs-params">(value)</span> -&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              <p>user defined custom handlers takes precedence</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    customHandler = getValueHandler(value, <span class="hljs-property">@options</span>.valueHandlers, cls.globalValueHandlers)
    <span class="hljs-keyword">if</span> customHandler</pre></div></div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-37">&#182;</a>
              </div>
              <p>use the custom handler if available</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      value = customHandler(value)

    value</pre></div></div>
            
        </li>
        
        
        <li id="section-38">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-38">&#182;</a>
              </div>
              <p>Format the given field value for inclusion into the query string</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">_formatValue</span>: <span class="hljs-function"><span class="hljs-params">(value)</span> -&gt;</span>
    value = <span class="hljs-property">@_formatCustomValue</span>(value)

    <span class="hljs-keyword">if</span> <span class="hljs-literal">null</span> <span class="hljs-keyword">is</span> value
      value = <span class="hljs-string">"NULL"</span>
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> <span class="hljs-string">"boolean"</span> <span class="hljs-keyword">is</span> <span class="hljs-keyword">typeof</span> value
      value = <span class="hljs-keyword">if</span> value <span class="hljs-keyword">then</span> <span class="hljs-string">"TRUE"</span> <span class="hljs-keyword">else</span> <span class="hljs-string">"FALSE"</span>
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> <span class="hljs-string">"number"</span> <span class="hljs-keyword">isnt</span> <span class="hljs-keyword">typeof</span> value
      value = <span class="hljs-property">@_escapeValue</span>(value)
      value = <span class="hljs-string">"'<span class="hljs-subst">#{value}</span>'"</span>

    value</pre></div></div>
            
        </li>
        
        
        <li id="section-39">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-39">&#182;</a>
              </div>
              <hr>

            </div>
            
        </li>
        
        
        <li id="section-40">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-40">&#182;</a>
              </div>
              <hr>

            </div>
            
        </li>
        
        
        <li id="section-41">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-41">&#182;</a>
              </div>
              <h2 id="cls-expressions">cls.Expressions</h2>

            </div>
            
        </li>
        
        
        <li id="section-42">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-42">&#182;</a>
              </div>
              <hr>

            </div>
            
        </li>
        
        
        <li id="section-43">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-43">&#182;</a>
              </div>
              
            </div>
            
        </li>
        
        
        <li id="section-44">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-44">&#182;</a>
              </div>
              <p>An SQL expression builder.</p>
<p>SQL expressions are used in WHERE and ON clauses to filter data by various criteria.</p>
<p>This builder works by building up the expression as a hierarchical tree of nodes. The toString() method then
traverses this tree in order to build the final expression string.</p>
<p>cls.Expressions can be nested. Nested expression contains can themselves contain nested expressions.
When rendered a nested expression will be fully contained within brackets.</p>
<p>All the build methods in this object return the object instance for chained method calling purposes.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">cls</span>.<span class="hljs-title">Expression</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">cls</span>.<span class="hljs-title">Cloneable</span></span></pre></div></div>
            
        </li>
        
        
        <li id="section-45">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-45">&#182;</a>
              </div>
              <p>The expression tree.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-attribute">tree</span>: <span class="hljs-literal">null</span></pre></div></div>
            
        </li>
        
        
        <li id="section-46">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-46">&#182;</a>
              </div>
              <p>The part of the expression tree we’re currently working on.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-attribute">current</span>: <span class="hljs-literal">null</span></pre></div></div>
            
        </li>
        
        
        <li id="section-47">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-47">&#182;</a>
              </div>
              <p>Initialise the expression.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-attribute">constructor</span>:<span class="hljs-function"> -&gt;</span>
        <span class="hljs-property">@tree</span> =
            <span class="hljs-attribute">parent</span>: <span class="hljs-literal">null</span>
            <span class="hljs-attribute">nodes</span>: []
        <span class="hljs-property">@current</span> = <span class="hljs-property">@tree</span></pre></div></div>
            
        </li>
        
        
        <li id="section-48">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-48">&#182;</a>
              </div>
              <p>Begin a nested expression and combine it with the current expression using the given operator.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-property">@_begin</span> = <span class="hljs-function"><span class="hljs-params">(op)</span> =&gt;</span>
            new_tree =
                <span class="hljs-attribute">type</span>: op
                <span class="hljs-attribute">parent</span>: <span class="hljs-property">@current</span>
                <span class="hljs-attribute">nodes</span>: []
            <span class="hljs-property">@current</span>.nodes.push new_tree
            <span class="hljs-property">@current</span> = <span class="hljs-property">@current</span>.nodes[<span class="hljs-property">@current</span>.nodes.length-<span class="hljs-number">1</span>]
            @</pre></div></div>
            
        </li>
        
        
        <li id="section-49">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-49">&#182;</a>
              </div>
              <p>Begin a nested expression and combine it with the current expression using the intersection operator (AND).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-attribute">and_begin</span>:<span class="hljs-function"> -&gt;</span>
        <span class="hljs-property">@_begin</span> <span class="hljs-string">'AND'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-50">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-50">&#182;</a>
              </div>
              <p>Begin a nested expression and combine it with the current expression using the union operator (OR).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-attribute">or_begin</span>:<span class="hljs-function"> -&gt;</span>
        <span class="hljs-property">@_begin</span> <span class="hljs-string">'OR'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-51">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-51">&#182;</a>
              </div>
              <p>End the current compound expression.</p>
<p>This will throw an error if begin() hasn’t been called yet.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-attribute">end</span>:<span class="hljs-function"> -&gt;</span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-property">@current</span>.parent
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Error <span class="hljs-string">"begin() needs to be called"</span>
        <span class="hljs-property">@current</span> = <span class="hljs-property">@current</span>.parent
        @</pre></div></div>
            
        </li>
        
        
        <li id="section-52">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-52">&#182;</a>
              </div>
              <p>Combine the current expression with the given expression using the intersection operator (AND).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-attribute">and</span>: <span class="hljs-function"><span class="hljs-params">(expr)</span> -&gt;</span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> expr <span class="hljs-keyword">or</span> <span class="hljs-string">"string"</span> <span class="hljs-keyword">isnt</span> <span class="hljs-keyword">typeof</span> expr
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Error <span class="hljs-string">"expr must be a string"</span>
        <span class="hljs-property">@current</span>.nodes.push
            <span class="hljs-attribute">type</span>: <span class="hljs-string">'AND'</span>
            <span class="hljs-attribute">expr</span>: expr
        @</pre></div></div>
            
        </li>
        
        
        <li id="section-53">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-53">&#182;</a>
              </div>
              <p>Combine the current expression with the given expression using the union operator (OR).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-attribute">or</span>: <span class="hljs-function"><span class="hljs-params">(expr)</span> -&gt;</span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> expr <span class="hljs-keyword">or</span> <span class="hljs-string">"string"</span> <span class="hljs-keyword">isnt</span> <span class="hljs-keyword">typeof</span> expr
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Error <span class="hljs-string">"expr must be a string"</span>
        <span class="hljs-property">@current</span>.nodes.push
            <span class="hljs-attribute">type</span>: <span class="hljs-string">'OR'</span>
            <span class="hljs-attribute">expr</span>: expr
        @</pre></div></div>
            
        </li>
        
        
        <li id="section-54">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-54">&#182;</a>
              </div>
              <p>Get the final fully constructed expression string.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-attribute">toString</span>:<span class="hljs-function"> -&gt;</span>
        <span class="hljs-keyword">if</span> <span class="hljs-literal">null</span> <span class="hljs-keyword">isnt</span> <span class="hljs-property">@current</span>.parent
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Error <span class="hljs-string">"end() needs to be called"</span>
        _toString <span class="hljs-property">@tree</span></pre></div></div>
            
        </li>
        
        
        <li id="section-55">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-55">&#182;</a>
              </div>
              <p>Get a string representation of the given expression tree node.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-function"><span class="hljs-title">_toString</span> = <span class="hljs-params">(node)</span> -&gt;</span>
        str = <span class="hljs-string">""</span>
        <span class="hljs-keyword">for</span> child <span class="hljs-keyword">in</span> node.nodes
            <span class="hljs-keyword">if</span> child.expr?
                nodeStr = child.expr
            <span class="hljs-keyword">else</span>
                nodeStr = _toString(child)</pre></div></div>
            
        </li>
        
        
        <li id="section-56">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-56">&#182;</a>
              </div>
              <p>wrap nested expressions in brackets</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="hljs-keyword">if</span> <span class="hljs-string">""</span> <span class="hljs-keyword">isnt</span> nodeStr
                    nodeStr = <span class="hljs-string">"("</span> + nodeStr + <span class="hljs-string">")"</span>
            <span class="hljs-keyword">if</span> <span class="hljs-string">""</span> <span class="hljs-keyword">isnt</span> nodeStr</pre></div></div>
            
        </li>
        
        
        <li id="section-57">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-57">&#182;</a>
              </div>
              <p>if this isn’t first expression then add the operator</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="hljs-keyword">if</span> <span class="hljs-string">""</span> <span class="hljs-keyword">isnt</span> str <span class="hljs-keyword">then</span> str += <span class="hljs-string">" "</span> + child.type + <span class="hljs-string">" "</span>
                str += nodeStr
        str</pre></div></div>
            
        </li>
        
        
        <li id="section-58">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-58">&#182;</a>
              </div>
              <h1 id="-">#</h1>

            </div>
            
            <div class="content"><div class='highlight'><pre>    Clone <span class="hljs-keyword">this</span> expression.

    Note that the algorithm contained within <span class="hljs-keyword">this</span> method <span class="hljs-keyword">is</span> probably non-optimal, so please avoid cloning large
    expression trees.</pre></div></div>
            
        </li>
        
        
        <li id="section-59">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-59">&#182;</a>
              </div>
              <h1 id="-">#</h1>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-attribute">clone</span>:<span class="hljs-function"> -&gt;</span>
      newInstance = <span class="hljs-keyword">new</span> <span class="hljs-property">@constructor</span>;

      <span class="hljs-function"><span class="hljs-params">(_cloneTree = (node) -&gt;
        <span class="hljs-keyword">for</span> child <span class="hljs-keyword">in</span> node.nodes
          <span class="hljs-keyword">if</span> child.expr?
            newInstance.current.nodes.push JSON.parse(JSON.stringify(child))
          <span class="hljs-keyword">else</span>
            newInstance._begin child.type
            _cloneTree child
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-property">@current</span> <span class="hljs-keyword">is</span> child
              newInstance.end()
      )(<span class="hljs-property">@tree</span>)</span>

      <span class="hljs-title">newInstance</span>





</span></pre></div></div>
            
        </li>
        
        
        <li id="section-60">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-60">&#182;</a>
              </div>
              <hr>

            </div>
            
        </li>
        
        
        <li id="section-61">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-61">&#182;</a>
              </div>
              <hr>

            </div>
            
        </li>
        
        
        <li id="section-62">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-62">&#182;</a>
              </div>
              <h2 id="building-blocks">Building blocks</h2>

            </div>
            
        </li>
        
        
        <li id="section-63">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-63">&#182;</a>
              </div>
              <hr>

            </div>
            
        </li>
        
        
        <li id="section-64">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-64">&#182;</a>
              </div>
              
            </div>
            
        </li>
        
        
        <li id="section-65">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-65">&#182;</a>
              </div>
              <p>A building block represents a single build-step within a query building process.</p>
<p>Query builders consist of one or more building blocks which get run in a particular order. Building blocks can
optionally specify methods to expose through the query builder interface. They can access all the input data for
the query builder and manipulate it as necessary, as well as append to the final query string output.</p>
<p>If you wish to customize how queries get built or add proprietary query phrases and content then it is recommended
that you do so using one or more custom building blocks.</p>
<p>Original idea posted in <a href="https://github.com/hiddentao/export/issues/10#issuecomment-15016427">https://github.com/hiddentao/export/issues/10#issuecomment-15016427</a></p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">cls</span>.<span class="hljs-title">Block</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">cls</span>.<span class="hljs-title">BaseBuilder</span></span></pre></div></div>
            
        </li>
        
        
        <li id="section-66">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-66">&#182;</a>
              </div>
              <p>Get input methods to expose within the query builder.</p>
<p>By default all methods except the following get returned:
  methods prefixed with _
  constructor and buildStr()</p>
<p>@return Object key -&gt; function pairs</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">exposedMethods</span>:<span class="hljs-function"> -&gt;</span>
    ret = {}

    <span class="hljs-keyword">for</span> attr, value <span class="hljs-keyword">of</span> @</pre></div></div>
            
        </li>
        
        
        <li id="section-67">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-67">&#182;</a>
              </div>
              <p>only want functions from this class</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span> <span class="hljs-keyword">typeof</span> value <span class="hljs-keyword">is</span> <span class="hljs-string">"function"</span> <span class="hljs-keyword">and</span> attr.charAt(<span class="hljs-number">0</span>) <span class="hljs-keyword">isnt</span> <span class="hljs-string">'_'</span> <span class="hljs-keyword">and</span> !cls.<span class="hljs-attribute">Block</span>::[attr]
        ret[attr] = value

    ret</pre></div></div>
            
        </li>
        
        
        <li id="section-68">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-68">&#182;</a>
              </div>
              <p>Build this block.</p>
<p>Subclasses may override this method.</p>
<p>@param queryBuilder cls.QueryBuilder a reference to the query builder that owns this block.</p>
<p>@return String the string representing this block</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">buildStr</span>: <span class="hljs-function"><span class="hljs-params">(queryBuilder)</span> -&gt;</span>
    <span class="hljs-string">''</span>

  <span class="hljs-attribute">buildParam</span>: <span class="hljs-function"><span class="hljs-params">(queryBuilder)</span> -&gt;</span>
    { <span class="hljs-attribute">text</span>: <span class="hljs-property">@buildStr</span>(queryBuilder), <span class="hljs-attribute">values</span>: [] }</pre></div></div>
            
        </li>
        
        
        <li id="section-69">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-69">&#182;</a>
              </div>
              <p>A String which always gets output</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">cls</span>.<span class="hljs-title">StringBlock</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">cls</span>.<span class="hljs-title">Block</span></span>
  <span class="hljs-attribute">constructor</span>: <span class="hljs-function"><span class="hljs-params">(options, str)</span> -&gt;</span>
    <span class="hljs-keyword">super</span> options
    <span class="hljs-property">@str</span> = str

  <span class="hljs-attribute">buildStr</span>: <span class="hljs-function"><span class="hljs-params">(queryBuilder)</span> -&gt;</span>
    <span class="hljs-property">@str</span></pre></div></div>
            
        </li>
        
        
        <li id="section-70">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-70">&#182;</a>
              </div>
              <p>Table specifier base class</p>
<p>Additional options</p>
<ul>
<li>singleTable - only allow one table to be specified  (default: false)</li>
<li>allowNested - allow nested query to be specified as a table    (default: false)</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">cls</span>.<span class="hljs-title">AbstractTableBlock</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">cls</span>.<span class="hljs-title">Block</span></span>
  <span class="hljs-attribute">constructor</span>: <span class="hljs-function"><span class="hljs-params">(options)</span> -&gt;</span>
    <span class="hljs-keyword">super</span> options
    <span class="hljs-property">@tables</span> = []</pre></div></div>
            
        </li>
        
        
        <li id="section-71">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-71">&#182;</a>
              </div>
              <p>Update given table.</p>
<p>An alias may also be specified for the table.</p>
<p>Concrete subclasses should provide a method which calls this</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">_table</span>: <span class="hljs-function"><span class="hljs-params">(table, alias = <span class="hljs-literal">null</span>)</span> -&gt;</span>
    alias = <span class="hljs-property">@_sanitizeTableAlias</span>(alias) <span class="hljs-keyword">if</span> alias
    table = <span class="hljs-property">@_sanitizeTable</span>(table, <span class="hljs-property">@options</span>.allowNested <span class="hljs-keyword">or</span> <span class="hljs-literal">false</span>)

    <span class="hljs-keyword">if</span> <span class="hljs-property">@options</span>.singleTable
      <span class="hljs-property">@tables</span> = []

    <span class="hljs-property">@tables</span>.push
      <span class="hljs-attribute">table</span>: table
      <span class="hljs-attribute">alias</span>: alias

  <span class="hljs-attribute">buildStr</span>: <span class="hljs-function"><span class="hljs-params">(queryBuilder)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> <span class="hljs-number">0</span> &gt;= <span class="hljs-property">@tables</span>.length <span class="hljs-keyword">then</span> <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Error <span class="hljs-string">"_table() needs to be called"</span>

    tables = <span class="hljs-string">""</span>
    <span class="hljs-keyword">for</span> table <span class="hljs-keyword">in</span> <span class="hljs-property">@tables</span>
      tables += <span class="hljs-string">", "</span> <span class="hljs-keyword">if</span> <span class="hljs-string">""</span> <span class="hljs-keyword">isnt</span> tables
      <span class="hljs-keyword">if</span> <span class="hljs-string">"string"</span> <span class="hljs-keyword">is</span> <span class="hljs-keyword">typeof</span> table.table
        tables += table.table
      <span class="hljs-keyword">else</span></pre></div></div>
            
        </li>
        
        
        <li id="section-72">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-72">&#182;</a>
              </div>
              <p>building a nested query</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        tables += <span class="hljs-string">"(<span class="hljs-subst">#{table.table}</span>)"</span>

      <span class="hljs-keyword">if</span> table.alias</pre></div></div>
            
        </li>
        
        
        <li id="section-73">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-73">&#182;</a>
              </div>
              <p>add the table alias, the AS keyword is optional</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        tables += <span class="hljs-string">" <span class="hljs-subst">#{table.alias}</span>"</span>

    tables</pre></div></div>
            
        </li>
        
        
        <li id="section-74">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-74">&#182;</a>
              </div>
              <p>Update Table</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">cls</span>.<span class="hljs-title">UpdateTableBlock</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">cls</span>.<span class="hljs-title">AbstractTableBlock</span></span>
  <span class="hljs-attribute">table</span>: <span class="hljs-function"><span class="hljs-params">(table, alias = <span class="hljs-literal">null</span>)</span> -&gt;</span>
    <span class="hljs-property">@_table</span>(table, alias)</pre></div></div>
            
        </li>
        
        
        <li id="section-75">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-75">&#182;</a>
              </div>
              <p>FROM table</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">cls</span>.<span class="hljs-title">FromTableBlock</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">cls</span>.<span class="hljs-title">AbstractTableBlock</span></span>
  <span class="hljs-attribute">from</span>: <span class="hljs-function"><span class="hljs-params">(table, alias = <span class="hljs-literal">null</span>)</span> -&gt;</span>
    <span class="hljs-property">@_table</span>(table, alias)

  <span class="hljs-attribute">buildStr</span>: <span class="hljs-function"><span class="hljs-params">(queryBuilder)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> <span class="hljs-number">0</span> &gt;= <span class="hljs-property">@tables</span>.length <span class="hljs-keyword">then</span> <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Error <span class="hljs-string">"from() needs to be called"</span>

    tables = <span class="hljs-keyword">super</span> queryBuilder

    <span class="hljs-string">"FROM <span class="hljs-subst">#{tables}</span>"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-76">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-76">&#182;</a>
              </div>
              <p>INTO table</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">cls</span>.<span class="hljs-title">IntoTableBlock</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">cls</span>.<span class="hljs-title">Block</span></span>
  <span class="hljs-attribute">constructor</span>: <span class="hljs-function"><span class="hljs-params">(options)</span> -&gt;</span>
    <span class="hljs-keyword">super</span> options
    <span class="hljs-property">@table</span> = <span class="hljs-literal">null</span></pre></div></div>
            
        </li>
        
        
        <li id="section-77">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-77">&#182;</a>
              </div>
              <p>Into given table.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">into</span>: <span class="hljs-function"><span class="hljs-params">(table)</span> -&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-78">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-78">&#182;</a>
              </div>
              <p>do not allow nested table to be the target</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-property">@table</span> = <span class="hljs-property">@_sanitizeTable</span>(table, <span class="hljs-literal">false</span>)

  <span class="hljs-attribute">buildStr</span>: <span class="hljs-function"><span class="hljs-params">(queryBuilder)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-property">@table</span> <span class="hljs-keyword">then</span> <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Error <span class="hljs-string">"into() needs to be called"</span>
    <span class="hljs-string">"INTO <span class="hljs-subst">#{<span class="hljs-property">@table</span>}</span>"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-79">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-79">&#182;</a>
              </div>
              <p>(SELECT) Get field</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">cls</span>.<span class="hljs-title">GetFieldBlock</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">cls</span>.<span class="hljs-title">Block</span></span>
  <span class="hljs-attribute">constructor</span>: <span class="hljs-function"><span class="hljs-params">(options)</span> -&gt;</span>
    <span class="hljs-keyword">super</span> options
    <span class="hljs-property">@_fields</span> = []</pre></div></div>
            
        </li>
        
        
        <li id="section-80">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-80">&#182;</a>
              </div>
              <p>Add the given fields to the final result set.</p>
<p>The parameter is an Object containing field names (or database functions) as the keys and aliases for the fields
as the values. If the value for a key is null then no alias is set for that field.</p>
<p>Internally this method simply calls the field() method of this block to add each individual field.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">fields</span>: <span class="hljs-function"><span class="hljs-params">(_fields)</span> -&gt;</span>
    <span class="hljs-keyword">for</span> field, alias <span class="hljs-keyword">of</span> _fields
      <span class="hljs-property">@field</span>(field, alias)</pre></div></div>
            
        </li>
        
        
        <li id="section-81">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-81">&#182;</a>
              </div>
              <p>Add the given field to the final result set.</p>
<p>The ‘field’ parameter does not necessarily have to be a fieldname. It can use database functions too,
e.g. DATE_FORMAT(a.started, “%H”)</p>
<p>An alias may also be specified for this field.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">field</span>: <span class="hljs-function"><span class="hljs-params">(field, alias = <span class="hljs-literal">null</span>)</span> -&gt;</span>
    field = <span class="hljs-property">@_sanitizeField</span>(field)
    alias = <span class="hljs-property">@_sanitizeFieldAlias</span>(alias) <span class="hljs-keyword">if</span> alias

    <span class="hljs-property">@_fields</span>.push
      <span class="hljs-attribute">name</span>: field
      <span class="hljs-attribute">alias</span>: alias

  <span class="hljs-attribute">buildStr</span>: <span class="hljs-function"><span class="hljs-params">(queryBuilder)</span> -&gt;</span>
    fields = <span class="hljs-string">""</span>
    <span class="hljs-keyword">for</span> field <span class="hljs-keyword">in</span> <span class="hljs-property">@_fields</span>
      fields += <span class="hljs-string">", "</span> <span class="hljs-keyword">if</span> <span class="hljs-string">""</span> <span class="hljs-keyword">isnt</span> fields
      fields += field.name
      fields += <span class="hljs-string">" AS <span class="hljs-subst">#{field.alias}</span>"</span> <span class="hljs-keyword">if</span> field.alias

    <span class="hljs-keyword">if</span> <span class="hljs-string">""</span> <span class="hljs-keyword">is</span> fields <span class="hljs-keyword">then</span> <span class="hljs-string">"*"</span> <span class="hljs-keyword">else</span> fields</pre></div></div>
            
        </li>
        
        
        <li id="section-82">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-82">&#182;</a>
              </div>
              <p>Base class for setting fields to values (used for INSERT and UPDATE queries)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">cls</span>.<span class="hljs-title">AbstractSetFieldBlock</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">cls</span>.<span class="hljs-title">Block</span></span>
  <span class="hljs-attribute">constructor</span>: <span class="hljs-function"><span class="hljs-params">(options)</span> -&gt;</span>
    <span class="hljs-keyword">super</span> options
    <span class="hljs-property">@fields</span> = []
    <span class="hljs-property">@values</span> = []</pre></div></div>
            
        </li>
        
        
        <li id="section-83">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-83">&#182;</a>
              </div>
              <p>Update the given field with the given value.
This will override any previously set value for the given field.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">set</span>: <span class="hljs-function"><span class="hljs-params">(field, value)</span> -&gt;</span>
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Error <span class="hljs-string">"Cannot call set or setFields on multiple rows of fields."</span>  <span class="hljs-keyword">if</span> <span class="hljs-property">@values</span>.length &gt; <span class="hljs-number">1</span>

    value = <span class="hljs-property">@_sanitizeValue</span>(value) <span class="hljs-keyword">if</span> <span class="hljs-literal">undefined</span> <span class="hljs-keyword">isnt</span> value</pre></div></div>
            
        </li>
        
        
        <li id="section-84">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-84">&#182;</a>
              </div>
              <p>Explicity overwrite existing fields</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    index = <span class="hljs-property">@fields</span>.indexOf(<span class="hljs-property">@_sanitizeField</span>(field))
    <span class="hljs-keyword">if</span> index <span class="hljs-keyword">isnt</span> -<span class="hljs-number">1</span>
      <span class="hljs-property">@values</span>[<span class="hljs-number">0</span>][index] = value
    <span class="hljs-keyword">else</span>
      <span class="hljs-property">@fields</span>.push <span class="hljs-property">@_sanitizeField</span>(field)
      index = <span class="hljs-property">@fields</span>.length - <span class="hljs-number">1</span></pre></div></div>
            
        </li>
        
        
        <li id="section-85">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-85">&#182;</a>
              </div>
              <p>The first value added needs to create the array of values for the row</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span> Array.isArray(<span class="hljs-property">@values</span>[<span class="hljs-number">0</span>])
        <span class="hljs-property">@values</span>[<span class="hljs-number">0</span>][index] = value
      <span class="hljs-keyword">else</span>
        <span class="hljs-property">@values</span>.push [value]
    @</pre></div></div>
            
        </li>
        
        
        <li id="section-86">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-86">&#182;</a>
              </div>
              <p>Insert fields based on the key/value pairs in the given object</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">setFields</span>: <span class="hljs-function"><span class="hljs-params">(fields)</span> -&gt;</span>
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Error <span class="hljs-string">"Expected an object but got "</span> + <span class="hljs-keyword">typeof</span> fields <span class="hljs-keyword">unless</span> <span class="hljs-keyword">typeof</span> fields <span class="hljs-keyword">is</span> <span class="hljs-string">'object'</span>

    <span class="hljs-keyword">for</span> own field <span class="hljs-keyword">of</span> fields
      <span class="hljs-property">@set</span> field, fields[field]
    @</pre></div></div>
            
        </li>
        
        
        <li id="section-87">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-87">&#182;</a>
              </div>
              <p>Insert multiple rows for the given fields. Accepts an array of objects.
This will override all previously set values for every field.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">setFieldsRows</span>: <span class="hljs-function"><span class="hljs-params">(fieldsRows)</span> -&gt;</span>
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Error <span class="hljs-string">"Expected an array of objects but got "</span> + <span class="hljs-keyword">typeof</span> fieldsRows <span class="hljs-keyword">unless</span> Array.isArray(fieldsRows)</pre></div></div>
            
        </li>
        
        
        <li id="section-88">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-88">&#182;</a>
              </div>
              <p>Reset the objects stored fields and values</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-property">@fields</span> = []
    <span class="hljs-property">@values</span> = []
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> [<span class="hljs-number">0.</span>..fieldsRows.length]
      <span class="hljs-keyword">for</span> own field <span class="hljs-keyword">of</span> fieldsRows[i]

        index = <span class="hljs-property">@fields</span>.indexOf(<span class="hljs-property">@_sanitizeField</span>(field))
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Error <span class="hljs-string">'All fields in subsequent rows must match the fields in the first row'</span> <span class="hljs-keyword">if</span> <span class="hljs-number">0</span> &lt; i <span class="hljs-keyword">and</span> -<span class="hljs-number">1</span> <span class="hljs-keyword">is</span> index</pre></div></div>
            
        </li>
        
        
        <li id="section-89">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-89">&#182;</a>
              </div>
              <p>Add field only if it hasn’t been added before</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> -<span class="hljs-number">1</span> <span class="hljs-keyword">is</span> index
          <span class="hljs-property">@fields</span>.push <span class="hljs-property">@_sanitizeField</span>(field) 
          index = <span class="hljs-property">@fields</span>.length - <span class="hljs-number">1</span>

        value = <span class="hljs-property">@_sanitizeValue</span>(fieldsRows[i][field])</pre></div></div>
            
        </li>
        
        
        <li id="section-90">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-90">&#182;</a>
              </div>
              <p>The first value added needs to add the array</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> Array.isArray(<span class="hljs-property">@values</span>[i])
          <span class="hljs-property">@values</span>[i][index] = value
        <span class="hljs-keyword">else</span>
          <span class="hljs-property">@values</span>[i] = [value]
    @

  <span class="hljs-attribute">buildStr</span>:<span class="hljs-function"> -&gt;</span>
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Error(<span class="hljs-string">'Not yet implemented'</span>)

  <span class="hljs-attribute">buildParam</span>:<span class="hljs-function"> -&gt;</span>
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Error(<span class="hljs-string">'Not yet implemented'</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-91">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-91">&#182;</a>
              </div>
              <p>(UPDATE) SET field=value</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">cls</span>.<span class="hljs-title">SetFieldBlock</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">cls</span>.<span class="hljs-title">AbstractSetFieldBlock</span></span>

  <span class="hljs-attribute">setFieldsRows</span>:<span class="hljs-function"> -&gt;</span>
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Error(<span class="hljs-string">'Cannot call setFieldRows for an UPDATE SET'</span>)

  <span class="hljs-attribute">buildStr</span>: <span class="hljs-function"><span class="hljs-params">(queryBuilder)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> <span class="hljs-number">0</span> &gt;= <span class="hljs-property">@fields</span>.length <span class="hljs-keyword">then</span> <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Error <span class="hljs-string">"set() needs to be called"</span>

    str = <span class="hljs-string">""</span>
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> [<span class="hljs-number">0.</span>..<span class="hljs-property">@fields</span>.length]
      field = <span class="hljs-property">@fields</span>[i]
      str += <span class="hljs-string">", "</span> <span class="hljs-keyword">if</span> <span class="hljs-string">""</span> <span class="hljs-keyword">isnt</span> str
      value = <span class="hljs-property">@values</span>[<span class="hljs-number">0</span>][i]
      <span class="hljs-keyword">if</span> <span class="hljs-keyword">typeof</span> value <span class="hljs-keyword">is</span> <span class="hljs-string">'undefined'</span>  <span class="hljs-comment"># e.g. if field is an expression such as: count = count + 1</span>
        str += field
      <span class="hljs-keyword">else</span>
        str += <span class="hljs-string">"<span class="hljs-subst">#{field}</span> = <span class="hljs-subst">#{<span class="hljs-property">@_formatValue</span>(value)}</span>"</span>

    <span class="hljs-string">"SET <span class="hljs-subst">#{str}</span>"</span>

  <span class="hljs-attribute">buildParam</span>: <span class="hljs-function"><span class="hljs-params">(queryBuilder)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> <span class="hljs-number">0</span> &gt;= <span class="hljs-property">@fields</span>.length <span class="hljs-keyword">then</span> <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Error <span class="hljs-string">"set() needs to be called"</span>

    str = <span class="hljs-string">""</span>
    vals = []
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> [<span class="hljs-number">0.</span>..<span class="hljs-property">@fields</span>.length]
      str += <span class="hljs-string">", "</span> <span class="hljs-keyword">if</span> <span class="hljs-string">""</span> <span class="hljs-keyword">isnt</span> str
      str += <span class="hljs-string">"<span class="hljs-subst">#{<span class="hljs-property">@fields</span>[i]}</span> = ?"</span>
      vals.push <span class="hljs-property">@_formatCustomValue</span>( <span class="hljs-property">@values</span>[<span class="hljs-number">0</span>][i] )

    { <span class="hljs-attribute">text</span>: <span class="hljs-string">"SET <span class="hljs-subst">#{str}</span>"</span>, <span class="hljs-attribute">values</span>: vals }</pre></div></div>
            
        </li>
        
        
        <li id="section-92">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-92">&#182;</a>
              </div>
              <p>(INSERT INTO) … field … value</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">cls</span>.<span class="hljs-title">InsertFieldValueBlock</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">cls</span>.<span class="hljs-title">AbstractSetFieldBlock</span></span>
  <span class="hljs-attribute">buildStr</span>: <span class="hljs-function"><span class="hljs-params">(queryBuilder)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> <span class="hljs-number">0</span> &gt;= <span class="hljs-property">@fields</span>.length <span class="hljs-keyword">then</span> <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Error <span class="hljs-string">"set() needs to be called"</span>

    vals = []
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> [<span class="hljs-number">0.</span>..<span class="hljs-property">@values</span>.length]
      <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> [<span class="hljs-number">0.</span>..<span class="hljs-property">@values</span>[i].length]
        formattedValue = <span class="hljs-property">@_formatValue</span>(<span class="hljs-property">@values</span>[i][j])
        <span class="hljs-keyword">if</span> <span class="hljs-string">'string'</span> <span class="hljs-keyword">is</span> <span class="hljs-keyword">typeof</span> vals[i]
          vals[i] += <span class="hljs-string">', '</span> + formattedValue          
        <span class="hljs-keyword">else</span> 
          vals[i] = <span class="hljs-string">''</span> + formattedValue

    <span class="hljs-string">"(<span class="hljs-subst">#{<span class="hljs-property">@fields</span>.join(<span class="hljs-string">', '</span>)}</span>) VALUES (<span class="hljs-subst">#{vals.join(<span class="hljs-string">'), ('</span>)}</span>)"</span>

  <span class="hljs-attribute">buildParam</span>: <span class="hljs-function"><span class="hljs-params">(queryBuilder)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> <span class="hljs-number">0</span> &gt;= <span class="hljs-property">@fields</span>.length <span class="hljs-keyword">then</span> <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Error <span class="hljs-string">"set() needs to be called"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-93">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-93">&#182;</a>
              </div>
              <p>fields</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    str = <span class="hljs-string">""</span>
    vals = []
    params = []
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> [<span class="hljs-number">0.</span>..<span class="hljs-property">@fields</span>.length]
      str += <span class="hljs-string">", "</span> <span class="hljs-keyword">if</span> <span class="hljs-string">""</span> <span class="hljs-keyword">isnt</span> str
      str += <span class="hljs-property">@fields</span>[i]

     <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> [<span class="hljs-number">0.</span>..<span class="hljs-property">@values</span>.length]
      <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> [<span class="hljs-number">0.</span>..<span class="hljs-property">@values</span>[i].length]
        params.push <span class="hljs-property">@_formatCustomValue</span>( <span class="hljs-property">@values</span>[i][j] )
        <span class="hljs-keyword">if</span> <span class="hljs-string">'string'</span> <span class="hljs-keyword">is</span> <span class="hljs-keyword">typeof</span> vals[i]
          vals[i] += <span class="hljs-string">', ?'</span>           
        <span class="hljs-keyword">else</span> 
          vals[i] = <span class="hljs-string">'?'</span>

    { <span class="hljs-attribute">text</span>: <span class="hljs-string">"(<span class="hljs-subst">#{str}</span>) VALUES (<span class="hljs-subst">#{vals.join(<span class="hljs-string">'), ('</span>)}</span>)"</span>, <span class="hljs-attribute">values</span>: params }</pre></div></div>
            
        </li>
        
        
        <li id="section-94">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-94">&#182;</a>
              </div>
              <p>DISTINCT</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">cls</span>.<span class="hljs-title">DistinctBlock</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">cls</span>.<span class="hljs-title">Block</span></span>
  <span class="hljs-attribute">constructor</span>: <span class="hljs-function"><span class="hljs-params">(options)</span> -&gt;</span>
    <span class="hljs-keyword">super</span> options
    <span class="hljs-property">@useDistinct</span> = <span class="hljs-literal">false</span></pre></div></div>
            
        </li>
        
        
        <li id="section-95">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-95">&#182;</a>
              </div>
              <p>Add the DISTINCT keyword to the query.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">distinct</span>:<span class="hljs-function"> -&gt;</span>
    <span class="hljs-property">@useDistinct</span> = <span class="hljs-literal">true</span>

  <span class="hljs-attribute">buildStr</span>: <span class="hljs-function"><span class="hljs-params">(queryBuilder)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> <span class="hljs-property">@useDistinct</span> <span class="hljs-keyword">then</span> <span class="hljs-string">"DISTINCT"</span> <span class="hljs-keyword">else</span> <span class="hljs-string">""</span></pre></div></div>
            
        </li>
        
        
        <li id="section-96">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-96">&#182;</a>
              </div>
              <p>GROUP BY</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">cls</span>.<span class="hljs-title">GroupByBlock</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">cls</span>.<span class="hljs-title">Block</span></span>
  <span class="hljs-attribute">constructor</span>: <span class="hljs-function"><span class="hljs-params">(options)</span> -&gt;</span>
    <span class="hljs-keyword">super</span> options
    <span class="hljs-property">@groups</span> = []</pre></div></div>
            
        </li>
        
        
        <li id="section-97">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-97">&#182;</a>
              </div>
              <p>Add a GROUP BY transformation for the given field.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">group</span>: <span class="hljs-function"><span class="hljs-params">(field)</span> -&gt;</span>
    field = <span class="hljs-property">@_sanitizeField</span>(field)
    <span class="hljs-property">@groups</span>.push field

  <span class="hljs-attribute">buildStr</span>: <span class="hljs-function"><span class="hljs-params">(queryBuilder)</span> -&gt;</span>
    groups = <span class="hljs-string">""</span>

    <span class="hljs-keyword">if</span> <span class="hljs-number">0</span> &lt; <span class="hljs-property">@groups</span>.length
      <span class="hljs-keyword">for</span> f <span class="hljs-keyword">in</span> <span class="hljs-property">@groups</span>
        groups += <span class="hljs-string">", "</span> <span class="hljs-keyword">if</span> <span class="hljs-string">""</span> <span class="hljs-keyword">isnt</span> groups
        groups += f
      groups = <span class="hljs-string">"GROUP BY <span class="hljs-subst">#{groups}</span>"</span>

    groups</pre></div></div>
            
        </li>
        
        
        <li id="section-98">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-98">&#182;</a>
              </div>
              <p>OFFSET x</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">cls</span>.<span class="hljs-title">OffsetBlock</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">cls</span>.<span class="hljs-title">Block</span></span>
  <span class="hljs-attribute">constructor</span>: <span class="hljs-function"><span class="hljs-params">(options)</span> -&gt;</span>
    <span class="hljs-keyword">super</span> options
    <span class="hljs-property">@offsets</span> = <span class="hljs-literal">null</span></pre></div></div>
            
        </li>
        
        
        <li id="section-99">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-99">&#182;</a>
              </div>
              <p>Set the OFFSET transformation.</p>
<p>Call this will override the previously set offset for this query. Also note that Passing 0 for ‘max’ will remove
the offset.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">offset</span>: <span class="hljs-function"><span class="hljs-params">(start)</span> -&gt;</span>
    start = <span class="hljs-property">@_sanitizeLimitOffset</span>(start)
    <span class="hljs-property">@offsets</span> = start

  <span class="hljs-attribute">buildStr</span>: <span class="hljs-function"><span class="hljs-params">(queryBuilder)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> <span class="hljs-property">@offsets</span> <span class="hljs-keyword">then</span> <span class="hljs-string">"OFFSET <span class="hljs-subst">#{<span class="hljs-property">@offsets</span>}</span>"</span> <span class="hljs-keyword">else</span> <span class="hljs-string">""</span></pre></div></div>
            
        </li>
        
        
        <li id="section-100">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-100">&#182;</a>
              </div>
              <p>WHERE</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">cls</span>.<span class="hljs-title">WhereBlock</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">cls</span>.<span class="hljs-title">Block</span></span>
  <span class="hljs-attribute">constructor</span>: <span class="hljs-function"><span class="hljs-params">(options)</span> -&gt;</span>
    <span class="hljs-keyword">super</span> options
    <span class="hljs-property">@wheres</span> = []</pre></div></div>
            
        </li>
        
        
        <li id="section-101">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-101">&#182;</a>
              </div>
              <p>Add a WHERE condition.</p>
<p>When the final query is constructed all the WHERE conditions are combined using the intersection (AND) operator.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">where</span>: <span class="hljs-function"><span class="hljs-params">(condition, values...)</span> -&gt;</span>
    condition = <span class="hljs-property">@_sanitizeCondition</span>(condition)

    finalCondition = <span class="hljs-string">""</span>
    finalValues = []

    <span class="hljs-keyword">for</span> idx <span class="hljs-keyword">in</span> [<span class="hljs-number">0.</span>..condition.length]
      c = condition.charAt(idx)
      <span class="hljs-keyword">if</span> <span class="hljs-string">'?'</span> <span class="hljs-keyword">is</span> c <span class="hljs-keyword">and</span> <span class="hljs-number">0</span> &lt; values.length
        nextValue = values.shift()
        <span class="hljs-keyword">if</span> Array.isArray(nextValue) <span class="hljs-comment"># where b in (?, ? ?)</span>
          inValues = []
          <span class="hljs-keyword">for</span> item <span class="hljs-keyword">in</span> nextValue
            inValues.push <span class="hljs-property">@_sanitizeValue</span>(item)
          finalValues = finalValues.concat(inValues)
          finalCondition += <span class="hljs-string">"(<span class="hljs-subst">#{(<span class="hljs-string">'?'</span> <span class="hljs-keyword">for</span> item <span class="hljs-keyword">in</span> inValues).join <span class="hljs-string">', '</span>}</span>)"</span>
        <span class="hljs-keyword">else</span>
          finalCondition += <span class="hljs-string">'?'</span>
          finalValues.push <span class="hljs-property">@_sanitizeValue</span>(nextValue)
      <span class="hljs-keyword">else</span>
        finalCondition += c

    <span class="hljs-keyword">if</span> <span class="hljs-string">""</span> <span class="hljs-keyword">isnt</span> finalCondition
      <span class="hljs-property">@wheres</span>.push
        <span class="hljs-attribute">text</span>: finalCondition
        <span class="hljs-attribute">values</span>: finalValues


  <span class="hljs-attribute">buildStr</span>: <span class="hljs-function"><span class="hljs-params">(queryBuilder)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> <span class="hljs-number">0</span> &gt;= <span class="hljs-property">@wheres</span>.length <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> <span class="hljs-string">""</span>

    whereStr = <span class="hljs-string">""</span>

    <span class="hljs-keyword">for</span> where <span class="hljs-keyword">in</span> <span class="hljs-property">@wheres</span>
      <span class="hljs-keyword">if</span> <span class="hljs-string">""</span> <span class="hljs-keyword">isnt</span> whereStr <span class="hljs-keyword">then</span> whereStr += <span class="hljs-string">") AND ("</span>
      <span class="hljs-keyword">if</span> <span class="hljs-number">0</span> &lt; where.values.length</pre></div></div>
            
        </li>
        
        
        <li id="section-102">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-102">&#182;</a>
              </div>
              <p>replace placeholders with actual parameter values</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">for</span> idx <span class="hljs-keyword">in</span> [<span class="hljs-number">0.</span>..where.text.length]
          c = where.text.charAt(idx)
          <span class="hljs-keyword">if</span> <span class="hljs-string">'?'</span> <span class="hljs-keyword">is</span> c
            whereStr += <span class="hljs-property">@_formatValue</span>( where.values.shift() )
          <span class="hljs-keyword">else</span>
            whereStr += c
      <span class="hljs-keyword">else</span>
        whereStr += where.text

    <span class="hljs-string">"WHERE (<span class="hljs-subst">#{whereStr}</span>)"</span>


  <span class="hljs-attribute">buildParam</span>: <span class="hljs-function"><span class="hljs-params">(queryBuilder)</span> -&gt;</span>
    ret = 
      <span class="hljs-attribute">text</span>: <span class="hljs-string">""</span>
      <span class="hljs-attribute">values</span>: []

    <span class="hljs-keyword">if</span> <span class="hljs-number">0</span> &gt;= <span class="hljs-property">@wheres</span>.length <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> ret

    whereStr = <span class="hljs-string">""</span>

    <span class="hljs-keyword">for</span> where <span class="hljs-keyword">in</span> <span class="hljs-property">@wheres</span>
      <span class="hljs-keyword">if</span> <span class="hljs-string">""</span> <span class="hljs-keyword">isnt</span> whereStr <span class="hljs-keyword">then</span> whereStr += <span class="hljs-string">") AND ("</span>
      whereStr += where.text
      <span class="hljs-keyword">for</span> v <span class="hljs-keyword">in</span> where.values
        ret.values.push( <span class="hljs-property">@_formatCustomValue</span> v )

    ret.text = <span class="hljs-string">"WHERE (<span class="hljs-subst">#{whereStr}</span>)"</span>
    ret</pre></div></div>
            
        </li>
        
        
        <li id="section-103">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-103">&#182;</a>
              </div>
              <p>ORDER BY</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">cls</span>.<span class="hljs-title">OrderByBlock</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">cls</span>.<span class="hljs-title">Block</span></span>
  <span class="hljs-attribute">constructor</span>: <span class="hljs-function"><span class="hljs-params">(options)</span> -&gt;</span>
    <span class="hljs-keyword">super</span> options
    <span class="hljs-property">@orders</span> = []</pre></div></div>
            
        </li>
        
        
        <li id="section-104">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-104">&#182;</a>
              </div>
              <p>Add an ORDER BY transformation for the given field in the given order.</p>
<p>To specify descending order pass false for the ‘asc’ parameter.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">order</span>: <span class="hljs-function"><span class="hljs-params">(field, asc = <span class="hljs-literal">true</span>)</span> -&gt;</span>
    field = <span class="hljs-property">@_sanitizeField</span>(field)
    <span class="hljs-property">@orders</span>.push
      <span class="hljs-attribute">field</span>: field
      <span class="hljs-attribute">dir</span>: <span class="hljs-keyword">if</span> asc <span class="hljs-keyword">then</span> <span class="hljs-literal">true</span> <span class="hljs-keyword">else</span> <span class="hljs-literal">false</span>

  <span class="hljs-attribute">buildStr</span>: <span class="hljs-function"><span class="hljs-params">(queryBuilder)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> <span class="hljs-number">0</span> &lt; <span class="hljs-property">@orders</span>.length
      orders = <span class="hljs-string">""</span>
      <span class="hljs-keyword">for</span> o <span class="hljs-keyword">in</span> <span class="hljs-property">@orders</span>
        orders += <span class="hljs-string">", "</span> <span class="hljs-keyword">if</span> <span class="hljs-string">""</span> <span class="hljs-keyword">isnt</span> orders
        orders += <span class="hljs-string">"<span class="hljs-subst">#{o.field}</span> <span class="hljs-subst">#{<span class="hljs-keyword">if</span> o.dir <span class="hljs-keyword">then</span> <span class="hljs-string">'ASC'</span> <span class="hljs-keyword">else</span> <span class="hljs-string">'DESC'</span>}</span>"</span>
      <span class="hljs-string">"ORDER BY <span class="hljs-subst">#{orders}</span>"</span>
    <span class="hljs-keyword">else</span>
      <span class="hljs-string">""</span></pre></div></div>
            
        </li>
        
        
        <li id="section-105">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-105">&#182;</a>
              </div>
              <p>LIMIT</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">cls</span>.<span class="hljs-title">LimitBlock</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">cls</span>.<span class="hljs-title">Block</span></span>
  <span class="hljs-attribute">constructor</span>: <span class="hljs-function"><span class="hljs-params">(options)</span> -&gt;</span>
    <span class="hljs-keyword">super</span> options
    <span class="hljs-property">@limits</span> = <span class="hljs-literal">null</span></pre></div></div>
            
        </li>
        
        
        <li id="section-106">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-106">&#182;</a>
              </div>
              <p>Set the LIMIT transformation.</p>
<p>Call this will override the previously set limit for this query. Also note that Passing 0 for ‘max’ will remove
the limit.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">limit</span>: <span class="hljs-function"><span class="hljs-params">(max)</span> -&gt;</span>
    max = <span class="hljs-property">@_sanitizeLimitOffset</span>(max)
    <span class="hljs-property">@limits</span> = max


  <span class="hljs-attribute">buildStr</span>: <span class="hljs-function"><span class="hljs-params">(queryBuilder)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> <span class="hljs-property">@limits</span> <span class="hljs-keyword">then</span> <span class="hljs-string">"LIMIT <span class="hljs-subst">#{<span class="hljs-property">@limits</span>}</span>"</span> <span class="hljs-keyword">else</span> <span class="hljs-string">""</span></pre></div></div>
            
        </li>
        
        
        <li id="section-107">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-107">&#182;</a>
              </div>
              <p>JOIN</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">cls</span>.<span class="hljs-title">JoinBlock</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">cls</span>.<span class="hljs-title">Block</span></span>
  <span class="hljs-attribute">constructor</span>: <span class="hljs-function"><span class="hljs-params">(options)</span> -&gt;</span>
    <span class="hljs-keyword">super</span> options
    <span class="hljs-property">@joins</span> = []</pre></div></div>
            
        </li>
        
        
        <li id="section-108">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-108">&#182;</a>
              </div>
              <p>Add a JOIN with the given table.</p>
<p>‘table’ is the name of the table to join with.</p>
<p>‘alias’ is an optional alias for the table name.</p>
<p>‘condition’ is an optional condition (containing an SQL expression) for the JOIN. If this is an instance of
an expression builder then it gets evaluated straight away.</p>
<p>‘type’ must be either one of INNER, OUTER, LEFT or RIGHT. Default is ‘INNER’.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">join</span>: <span class="hljs-function"><span class="hljs-params">(table, alias = <span class="hljs-literal">null</span>, condition = <span class="hljs-literal">null</span>, type = <span class="hljs-string">'INNER'</span>)</span> -&gt;</span>
    table = <span class="hljs-property">@_sanitizeTable</span>(table, <span class="hljs-literal">true</span>)
    alias = <span class="hljs-property">@_sanitizeTableAlias</span>(alias) <span class="hljs-keyword">if</span> alias
    condition = <span class="hljs-property">@_sanitizeCondition</span>(condition) <span class="hljs-keyword">if</span> condition

    <span class="hljs-property">@joins</span>.push
      <span class="hljs-attribute">type</span>: type
      <span class="hljs-attribute">table</span>: table
      <span class="hljs-attribute">alias</span>: alias
      <span class="hljs-attribute">condition</span>: condition
    @</pre></div></div>
            
        </li>
        
        
        <li id="section-109">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-109">&#182;</a>
              </div>
              <p>Add a LEFT JOIN with the given table.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">left_join</span>: <span class="hljs-function"><span class="hljs-params">(table, alias = <span class="hljs-literal">null</span>, condition = <span class="hljs-literal">null</span>)</span> -&gt;</span>
    <span class="hljs-property">@join</span> table, alias, condition, <span class="hljs-string">'LEFT'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-110">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-110">&#182;</a>
              </div>
              <p>Add a RIGHT JOIN with the given table.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">right_join</span>: <span class="hljs-function"><span class="hljs-params">(table, alias = <span class="hljs-literal">null</span>, condition = <span class="hljs-literal">null</span>)</span> -&gt;</span>
    <span class="hljs-property">@join</span> table, alias, condition, <span class="hljs-string">'RIGHT'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-111">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-111">&#182;</a>
              </div>
              <p>Add an OUTER JOIN with the given table.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">outer_join</span>: <span class="hljs-function"><span class="hljs-params">(table, alias = <span class="hljs-literal">null</span>, condition = <span class="hljs-literal">null</span>)</span> -&gt;</span>
    <span class="hljs-property">@join</span> table, alias, condition, <span class="hljs-string">'OUTER'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-112">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-112">&#182;</a>
              </div>
              <p>Add a LEFT JOIN with the given table.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">left_outer_join</span>: <span class="hljs-function"><span class="hljs-params">(table, alias = <span class="hljs-literal">null</span>, condition = <span class="hljs-literal">null</span>)</span> -&gt;</span>
    <span class="hljs-property">@join</span> table, alias, condition, <span class="hljs-string">'LEFT OUTER'</span>


  <span class="hljs-attribute">buildStr</span>: <span class="hljs-function"><span class="hljs-params">(queryBuilder)</span> -&gt;</span>
    joins = <span class="hljs-string">""</span>

    <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> (<span class="hljs-property">@joins</span> <span class="hljs-keyword">or</span> [])
      <span class="hljs-keyword">if</span> joins <span class="hljs-keyword">isnt</span> <span class="hljs-string">""</span> <span class="hljs-keyword">then</span> joins += <span class="hljs-string">" "</span>
      joins += <span class="hljs-string">"<span class="hljs-subst">#{j.type}</span> JOIN "</span>
      <span class="hljs-keyword">if</span> <span class="hljs-string">"string"</span> <span class="hljs-keyword">is</span> <span class="hljs-keyword">typeof</span> j.table
        joins += j.table
      <span class="hljs-keyword">else</span>
        joins += <span class="hljs-string">"(<span class="hljs-subst">#{j.table}</span>)"</span>
      joins += <span class="hljs-string">" <span class="hljs-subst">#{j.alias}</span>"</span> <span class="hljs-keyword">if</span> j.alias
      joins += <span class="hljs-string">" ON (<span class="hljs-subst">#{j.condition}</span>)"</span> <span class="hljs-keyword">if</span> j.condition

    joins</pre></div></div>
            
        </li>
        
        
        <li id="section-113">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-113">&#182;</a>
              </div>
              <hr>

            </div>
            
        </li>
        
        
        <li id="section-114">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-114">&#182;</a>
              </div>
              <hr>

            </div>
            
        </li>
        
        
        <li id="section-115">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-115">&#182;</a>
              </div>
              <h2 id="query-builders">Query builders</h2>

            </div>
            
        </li>
        
        
        <li id="section-116">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-116">&#182;</a>
              </div>
              <hr>

            </div>
            
        </li>
        
        
        <li id="section-117">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-117">&#182;</a>
              </div>
              
            </div>
            
        </li>
        
        
        <li id="section-118">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-118">&#182;</a>
              </div>
              <p>Query builder base class</p>
<p>Note that the query builder does not check the final query string for correctness.</p>
<p>All the build methods in this object return the object instance for chained method calling purposes.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">cls</span>.<span class="hljs-title">QueryBuilder</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">cls</span>.<span class="hljs-title">BaseBuilder</span></span></pre></div></div>
            
        </li>
        
        
        <li id="section-119">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-119">&#182;</a>
              </div>
              <p>Constructor</p>
<p>blocks - array of cls.BaseBuilderBlock instances to build the query with.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">constructor</span>: <span class="hljs-function"><span class="hljs-params">(options, blocks)</span> -&gt;</span>
    <span class="hljs-keyword">super</span> options

    <span class="hljs-property">@blocks</span> = blocks <span class="hljs-keyword">or</span> []</pre></div></div>
            
        </li>
        
        
        <li id="section-120">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-120">&#182;</a>
              </div>
              <p>Copy exposed methods into myself</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">for</span> block <span class="hljs-keyword">in</span> <span class="hljs-property">@blocks</span>
      <span class="hljs-keyword">for</span> methodName, methodBody <span class="hljs-keyword">of</span> block.exposedMethods()
        <span class="hljs-keyword">if</span> @[methodName]?
          <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Error <span class="hljs-string">"<span class="hljs-subst">#{<span class="hljs-property">@_getObjectClassName</span>(@)}</span> already has a builder method called: <span class="hljs-subst">#{methodName}</span>"</span>

        <span class="hljs-function"><span class="hljs-params">( (block, name, body) =&gt;
          @[name] = =&gt;
            body.apply(block, arguments)
            @
        )(block, methodName, methodBody)</span>


</span></pre></div></div>
            
        </li>
        
        
        <li id="section-121">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-121">&#182;</a>
              </div>
              <p>Register a custom value handler for this query builder and all its contained blocks.</p>
<p>Note: This will override any globally registered handler for this value type.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">registerValueHandler</span>: <span class="hljs-function"><span class="hljs-params">(type, handler)</span> -&gt;</span>
    <span class="hljs-keyword">for</span> block <span class="hljs-keyword">in</span> <span class="hljs-property">@blocks</span>
      block.registerValueHandler type, handler
    <span class="hljs-keyword">super</span> type, handler
    @</pre></div></div>
            
        </li>
        
        
        <li id="section-122">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-122">&#182;</a>
              </div>
              <p>Update query builder options</p>
<p>This will update the options for all blocks too. Use this method with caution as it allows you to change the
behaviour of your query builder mid-build.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">updateOptions</span>: <span class="hljs-function"><span class="hljs-params">(options)</span> -&gt;</span>
    <span class="hljs-property">@options</span> = _extend({}, <span class="hljs-property">@options</span>, options)
    <span class="hljs-keyword">for</span> block <span class="hljs-keyword">in</span> <span class="hljs-property">@blocks</span>
      block.options = _extend({}, block.options, options)</pre></div></div>
            
        </li>
        
        
        <li id="section-123">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-123">&#182;</a>
              </div>
              <p>Get the final fully constructed query string.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">toString</span>:<span class="hljs-function"> -&gt;</span>
    <span class="hljs-function"><span class="hljs-params">(block.buildStr(@) <span class="hljs-keyword">for</span> block <span class="hljs-keyword">in</span> <span class="hljs-property">@blocks</span>)</span>.<span class="hljs-title">filter</span><span class="hljs-params">( (v) -&gt; <span class="hljs-keyword">return</span> (<span class="hljs-number">0</span> &lt; v.length))</span>.<span class="hljs-title">join</span><span class="hljs-params">(<span class="hljs-string">' '</span>)</span>

</span></pre></div></div>
            
        </li>
        
        
        <li id="section-124">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-124">&#182;</a>
              </div>
              <p>Get the final fully constructed query param obj.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">toParam</span>:<span class="hljs-function"> -&gt;</span>
    result = { <span class="hljs-attribute">text</span>: <span class="hljs-string">''</span>, <span class="hljs-attribute">values</span>: [] }
    blocks = (block.buildParam(@) <span class="hljs-keyword">for</span> block <span class="hljs-keyword">in</span> <span class="hljs-property">@blocks</span>)
    result.<span class="hljs-function"><span class="hljs-title">text</span> = <span class="hljs-params">(block.text <span class="hljs-keyword">for</span> block <span class="hljs-keyword">in</span> blocks)</span>.<span class="hljs-title">filter</span><span class="hljs-params">( (v) -&gt; <span class="hljs-keyword">return</span> (<span class="hljs-number">0</span> &lt; v.length))</span>.<span class="hljs-title">join</span><span class="hljs-params">(<span class="hljs-string">' '</span>)</span>
    <span class="hljs-title">result</span>.<span class="hljs-title">values</span> = [].<span class="hljs-title">concat</span> <span class="hljs-params">(block.values <span class="hljs-keyword">for</span> block <span class="hljs-keyword">in</span> blocks)</span>...
    <span class="hljs-title">if</span> @<span class="hljs-title">options</span>.<span class="hljs-title">numberedParameters</span>
      <span class="hljs-title">i</span> = 0
      <span class="hljs-title">result</span>.<span class="hljs-title">text</span> = <span class="hljs-title">result</span>.<span class="hljs-title">text</span>.<span class="hljs-title">replace</span> /\?/<span class="hljs-title">g</span>, <span class="hljs-params">()</span> -&gt;</span> <span class="hljs-keyword">return</span> <span class="hljs-string">"$<span class="hljs-subst">#{++i}</span>"</span>
    result</pre></div></div>
            
        </li>
        
        
        <li id="section-125">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-125">&#182;</a>
              </div>
              <p>Deep clone</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">clone</span>:<span class="hljs-function"> -&gt;</span>
    <span class="hljs-keyword">new</span> <span class="hljs-property">@constructor</span> <span class="hljs-property">@options</span>, (block.clone() <span class="hljs-keyword">for</span> block <span class="hljs-keyword">in</span> <span class="hljs-property">@blocks</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-126">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-126">&#182;</a>
              </div>
              <p>Get whether queries built with this builder can be nested within other queries</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">isNestable</span>:<span class="hljs-function"> -&gt;</span>
    <span class="hljs-literal">false</span></pre></div></div>
            
        </li>
        
        
        <li id="section-127">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-127">&#182;</a>
              </div>
              <p>SELECT query builder.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">cls</span>.<span class="hljs-title">Select</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">cls</span>.<span class="hljs-title">QueryBuilder</span></span>
    <span class="hljs-attribute">constructor</span>: <span class="hljs-function"><span class="hljs-params">(options, blocks = <span class="hljs-literal">null</span>)</span> -&gt;</span>
      blocks <span class="hljs-keyword">or</span>= [
        <span class="hljs-keyword">new</span> cls.StringBlock(options, <span class="hljs-string">'SELECT'</span>),
        <span class="hljs-keyword">new</span> cls.DistinctBlock(options),
        <span class="hljs-keyword">new</span> cls.GetFieldBlock(options),
        <span class="hljs-keyword">new</span> cls.FromTableBlock(_extend({}, options, { <span class="hljs-attribute">allowNested</span>: <span class="hljs-literal">true</span> })),
        <span class="hljs-keyword">new</span> cls.JoinBlock(_extend({}, options, { <span class="hljs-attribute">allowNested</span>: <span class="hljs-literal">true</span> })),
        <span class="hljs-keyword">new</span> cls.WhereBlock(options),
        <span class="hljs-keyword">new</span> cls.GroupByBlock(options),
        <span class="hljs-keyword">new</span> cls.OrderByBlock(options),
        <span class="hljs-keyword">new</span> cls.LimitBlock(options),
        <span class="hljs-keyword">new</span> cls.OffsetBlock(options)
      ]

      <span class="hljs-keyword">super</span> options, blocks

    <span class="hljs-attribute">isNestable</span>:<span class="hljs-function"> -&gt;</span>
      <span class="hljs-literal">true</span></pre></div></div>
            
        </li>
        
        
        <li id="section-128">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-128">&#182;</a>
              </div>
              <p>UPDATE query builder.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">cls</span>.<span class="hljs-title">Update</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">cls</span>.<span class="hljs-title">QueryBuilder</span></span>
  <span class="hljs-attribute">constructor</span>: <span class="hljs-function"><span class="hljs-params">(options, blocks = <span class="hljs-literal">null</span>)</span> -&gt;</span>
    blocks <span class="hljs-keyword">or</span>= [
      <span class="hljs-keyword">new</span> cls.StringBlock(options, <span class="hljs-string">'UPDATE'</span>),
      <span class="hljs-keyword">new</span> cls.UpdateTableBlock(options),
      <span class="hljs-keyword">new</span> cls.SetFieldBlock(options),
      <span class="hljs-keyword">new</span> cls.WhereBlock(options),
      <span class="hljs-keyword">new</span> cls.OrderByBlock(options),
      <span class="hljs-keyword">new</span> cls.LimitBlock(options)
    ]

    <span class="hljs-keyword">super</span> options, blocks</pre></div></div>
            
        </li>
        
        
        <li id="section-129">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-129">&#182;</a>
              </div>
              <p>DELETE query builder.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">cls</span>.<span class="hljs-title">Delete</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">cls</span>.<span class="hljs-title">QueryBuilder</span></span>
  <span class="hljs-attribute">constructor</span>: <span class="hljs-function"><span class="hljs-params">(options, blocks = <span class="hljs-literal">null</span>)</span> -&gt;</span>
    blocks <span class="hljs-keyword">or</span>= [
      <span class="hljs-keyword">new</span> cls.StringBlock(options, <span class="hljs-string">'DELETE'</span>),
      <span class="hljs-keyword">new</span> cls.FromTableBlock( _extend({}, options, { <span class="hljs-attribute">singleTable</span>: <span class="hljs-literal">true</span> }) ),
      <span class="hljs-keyword">new</span> cls.JoinBlock(options),
      <span class="hljs-keyword">new</span> cls.WhereBlock(options),
      <span class="hljs-keyword">new</span> cls.OrderByBlock(options),
      <span class="hljs-keyword">new</span> cls.LimitBlock(options),
    ]

    <span class="hljs-keyword">super</span> options, blocks</pre></div></div>
            
        </li>
        
        
        <li id="section-130">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-130">&#182;</a>
              </div>
              <p>An INSERT query builder.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">cls</span>.<span class="hljs-title">Insert</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">cls</span>.<span class="hljs-title">QueryBuilder</span></span>
  <span class="hljs-attribute">constructor</span>: <span class="hljs-function"><span class="hljs-params">(options, blocks = <span class="hljs-literal">null</span>)</span> -&gt;</span>
    blocks <span class="hljs-keyword">or</span>= [
      <span class="hljs-keyword">new</span> cls.StringBlock(options, <span class="hljs-string">'INSERT'</span>),
      <span class="hljs-keyword">new</span> cls.IntoTableBlock(options),
      <span class="hljs-keyword">new</span> cls.InsertFieldValueBlock(options)
    ]

    <span class="hljs-keyword">super</span> options, blocks</pre></div></div>
            
        </li>
        
        
        <li id="section-131">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-131">&#182;</a>
              </div>
              <hr>

            </div>
            
        </li>
        
        
        <li id="section-132">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-132">&#182;</a>
              </div>
              <hr>

            </div>
            
        </li>
        
        
        <li id="section-133">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-133">&#182;</a>
              </div>
              <h2 id="exported-api">Exported API</h2>

            </div>
            
        </li>
        
        
        <li id="section-134">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-134">&#182;</a>
              </div>
              <hr>

            </div>
            
        </li>
        
        
        <li id="section-135">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-135">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>
squel =
  <span class="hljs-attribute">VERSION</span>: <span class="hljs-string">'2.0.0'</span>
  <span class="hljs-attribute">expr</span>:<span class="hljs-function"> -&gt;</span> <span class="hljs-keyword">new</span> cls.Expression</pre></div></div>
            
        </li>
        
        
        <li id="section-136">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-136">&#182;</a>
              </div>
              <p>Don’t have a space-efficient elegant-way of .apply()-ing to constructors, so we specify the args</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">select</span>: <span class="hljs-function"><span class="hljs-params">(options, blocks)</span> -&gt;</span> <span class="hljs-keyword">new</span> cls.Select(options, blocks)
  <span class="hljs-attribute">update</span>: <span class="hljs-function"><span class="hljs-params">(options, blocks)</span> -&gt;</span> <span class="hljs-keyword">new</span> cls.Update(options, blocks)
  <span class="hljs-attribute">insert</span>: <span class="hljs-function"><span class="hljs-params">(options, blocks)</span> -&gt;</span> <span class="hljs-keyword">new</span> cls.Insert(options, blocks)
  <span class="hljs-attribute">delete</span>: <span class="hljs-function"><span class="hljs-params">(options, blocks)</span> -&gt;</span> <span class="hljs-keyword">new</span> cls.Delete(options, blocks)
  <span class="hljs-attribute">registerValueHandler</span>: cls.registerValueHandler</pre></div></div>
            
        </li>
        
        
        <li id="section-137">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-137">&#182;</a>
              </div>
              <p>aliases</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>squel.remove = squel.<span class="hljs-keyword">delete</span></pre></div></div>
            
        </li>
        
        
        <li id="section-138">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-138">&#182;</a>
              </div>
              <p>classes</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>squel.cls = cls</pre></div></div>
            
        </li>
        
        
        <li id="section-139">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-139">&#182;</a>
              </div>
              <p>AMD</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">if</span> define?.amd
  define<span class="hljs-function"> -&gt;</span>
    <span class="hljs-keyword">return</span> squel</pre></div></div>
            
        </li>
        
        
        <li id="section-140">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-140">&#182;</a>
              </div>
              <p>CommonJS</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> <span class="hljs-built_in">module</span>?.<span class="hljs-built_in">exports</span>
  <span class="hljs-built_in">module</span>.<span class="hljs-built_in">exports</span> = squel</pre></div></div>
            
        </li>
        
        
        <li id="section-141">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-141">&#182;</a>
              </div>
              <p>Browser</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">else</span>
  <span class="hljs-built_in">window</span>?.squel = squel</pre></div></div>
            
        </li>
        
        
        <li id="section-142">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-142">&#182;</a>
              </div>
              <hr>

            </div>
            
        </li>
        
        
        <li id="section-143">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-143">&#182;</a>
              </div>
              <hr>

            </div>
            
        </li>
        
        
        <li id="section-144">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-144">&#182;</a>
              </div>
              <h2 id="squel-sql-flavours">Squel SQL flavours</h2>

            </div>
            
        </li>
        
        
        <li id="section-145">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-145">&#182;</a>
              </div>
              <hr>

            </div>
            
        </li>
        
        
        <li id="section-146">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-146">&#182;</a>
              </div>
              
            </div>
            
        </li>
        
        
        <li id="section-147">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-147">&#182;</a>
              </div>
              <p>Available flavours</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>squel.flavours = {}</pre></div></div>
            
        </li>
        
        
        <li id="section-148">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-148">&#182;</a>
              </div>
              <p>Setup Squel for a particular SQL flavour</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>squel.<span class="hljs-function"><span class="hljs-title">useFlavour</span> = <span class="hljs-params">(flavour)</span> -&gt;</span>
  <span class="hljs-keyword">if</span> squel.flavours[flavour] <span class="hljs-keyword">instanceof</span> Function
    squel.flavours[flavour].call <span class="hljs-literal">null</span>, squel
  <span class="hljs-keyword">else</span>
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Error <span class="hljs-string">"Flavour not available: <span class="hljs-subst">#{flavour}</span>"</span>
  squel</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
